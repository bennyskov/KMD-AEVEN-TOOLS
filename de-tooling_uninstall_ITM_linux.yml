---
- name: Create OS groups
  hosts: "{{ hostlist }}"
  become: false
  gather_facts: false
  connection: local
  tasks:
    - name: Create OS group
      group_by:
        key: "machine_{{ ostype }}"
      changed_when: false
      when: ostype is defined
      delegate_to: localhost

- name: Socks tunnel setup
  hosts: "{{ hostlist }}"
  gather_facts: false
  tasks:
    - include_role:
        name: ansible-role-event-socks-tunnel
        apply:
          check_mode: false
          run_once: true
          delegate_to: localhost
      vars:
        acc_id: "{{ blueid_shortcode }}"
        transaction_id: "{{ tower_job_id }}"
        trans_num: "{{ tower_job_id }}"

    - set_fact:
        ansible_become_user: root

- name: Get script result on linux nodes
  hosts: "{{ hostlist }}"
  become: true
  gather_facts: false
  tasks:
    - name: Copy, create, fetch file
      block:
        - name: Create prtemp_dir directory
          file:
            path: /tmp/scripttemp_dir
            state: directory
            mode: 0777

        - name: copy multiple items
          copy:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
            mode: 0777

          loop:
            - src: scripts/ITMAgentRepair_linux.pl
              dest: /tmp/scripttemp_dir/ITMAgentUNinstall_linux.pl

            - src: ITMconfig/
              dest: /tmp/scripttemp_dir/

        - name: Run command
          shell: perl -w ITMAgentRepair_linux.pl -d
          args:
            chdir: /tmp/scripttemp_dir
          register: script_run

        - name: Output list
          debug:
            var: script_run.stdout_lines

      always:
        - name: Delete scripttemp_dir directory
          file:
            path: /tmp/scripttemp_dir
            state: absent
