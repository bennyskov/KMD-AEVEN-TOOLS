#!/usr/bin/perl -w
# ---------------------------------------------------------------------------------------------------------------------------------------
#
#
#                                                                             dddddddd
#   kkkkkkkk                                                                  d::::::d                                        lllllll
#   k::::::k                                                                  d::::::d                                        l:::::l
#   k::::::k                                                                  d::::::d                                        l:::::l
#   k::::::k                                                                  d:::::d                                         l:::::l
#   k:::::k    kkkkkkkyyyyyyy           yyyyyyynnnn  nnnnnnnn        ddddddddd:::::drrrrr   rrrrrrrrryyyyyyy           yyyyyyyl::::l
#   k:::::k   k:::::k  y:::::y         y:::::y n:::nn::::::::nn    dd::::::::::::::dr::::rrr:::::::::ry:::::y         y:::::y l::::l
#   k:::::k  k:::::k    y:::::y       y:::::y  n::::::::::::::nn  d::::::::::::::::dr:::::::::::::::::ry:::::y       y:::::y  l::::l
#   k:::::k k:::::k      y:::::y     y:::::y   nn:::::::::::::::nd:::::::ddddd:::::drr::::::rrrrr::::::ry:::::y     y:::::y   l::::l
#   k::::::k:::::k        y:::::y   y:::::y      n:::::nnnn:::::nd::::::d    d:::::d r:::::r     r:::::r y:::::y   y:::::y    l::::l
#   k:::::::::::k          y:::::y y:::::y       n::::n    n::::nd:::::d     d:::::d r:::::r     rrrrrrr  y:::::y y:::::y     l::::l
#   k:::::::::::k           y:::::y:::::y        n::::n    n::::nd:::::d     d:::::d r:::::r               y:::::y:::::y      l::::l
#   k::::::k:::::k           y:::::::::y         n::::n    n::::nd:::::d     d:::::d r:::::r                y:::::::::y       l::::l
#   k::::::k k:::::k           y:::::::y          n::::n    n::::nd::::::ddddd::::::ddr:::::r                 y:::::::y       l::::::l
#   k::::::k  k:::::k           y:::::y           n::::n    n::::n d:::::::::::::::::dr:::::r                  y:::::y        l::::::l
#   k::::::k   k:::::k         y:::::y            n::::n    n::::n  d:::::::::ddd::::dr:::::r                 y:::::y         l::::::l
#   kkkkkkkk    kkkkkkk       y:::::y             nnnnnn    nnnnnn   ddddddddd   dddddrrrrrrr                y:::::y          llllllll
#                            y:::::y                                                                        y:::::y
#                           y:::::y                                                                        y:::::y
#                          y:::::y                                                                        y:::::y
#                         y:::::y                                                                        y:::::y
#                        yyyyyyy                                                                        yyyyyyy
#
#
# ---------------------------------------------------------------------------------------------------------------------------------------
# version 2023-08-01
# Changelog
#
# ITMAgentRepair_linux.pl  :   repair ITM agents locally on server
#
# 2023-08-01  Initial release ( Benny.Skov@kyndryl.com )
# -----------------------------------------------------------------------------------------------------------------
#
use strict;
use File::Basename;
# use File::Path qw(make_path);
# use Cwd qw(abs_path);
use Sys::Hostname;
use File::Copy;
my($foo,$bar,$baz,$qux,$quux,$quuz,$corge,$grault,$garply,$waldo,$fred,$plugh,$xyzzy,$thud);
my($envirShore,$step,$scriptname,$scriptn,@words);
my(@foo,@bar,@baz,@out,@trimin,$argnum);
my($cmdexec,$text,$debug,$csv_data,%hash_rtems,@csv_rows,@csv_lines,@fields,$line,$row,$count,$status,$ccode,$hostname,$itm_nodename);
my($rtemsCi,$rtemsIP,$rtemsConnect,$rtemsPairs,$rtemsFunction,$rtemsPrimSec,$rtemsTier,$rtemsEnvir,$rtemsShore,$result,$itmuser_found);
my($primary,$secondary,$pairsNumber,$CT_CMSLIST,$rtems_file,$handle,$agent,$shore,$envir);
my($silent_config_data,$silent_config_linux_git,$silent_config_linux,$pingonly);
my($env_file,$env_file_git,$env_data);
my($ini_file,$ini_file_git,$ini_data);
my($con_file,$con_file_git,$agent_con_data);
my($special_cfg,$special_cfg_git,$group,$userid);
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# INIT
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
$hostname           = hostname;
$hostname           = lc($hostname);
$scriptname         = $0;
$scriptname         =~ s/\\/\//g; # turn slash
@words              = split(/\//, $scriptname);
$scriptn            = $words[$#words];
$scriptn            =~ s/\.pl//g;
$debug              = 0;
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# read input
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
$debug = 1;
plog("\nhostname: $hostname");
plog("\ndebug:    $debug");
plog("\nscriptn:  $scriptn");
if ( $hostname =~ /\./i) {
        ($hostname,$bar) = split(/\./, $hostname, -1);
}
# ----------------------------------------------------------------------------------------------------------------------------
# help
# ----------------------------------------------------------------------------------------------------------------------------
sub help_error {
		print ("\n");
		print ("\n");
		print ("use: -?, for this message\n");
                print ("use: -d, for debug\n");
		print ("\n");
		print ("\n");
		exit;
}
# -----------------------------------------------------------------------------------------------------------------
# functions
# -----------------------------------------------------------------------------------------------------------------
sub get_date {
	our $day = ("00".."31")[(localtime)[3]];
	our $month = ("01".."12")[(localtime)[4]];
	our $year = ((localtime)[5] + 1900);
	$year = sprintf("%02d", $year % 100);
	our $hour = ("00".."23")[(localtime)[2]];
	our $min = ("00".."59")[(localtime)[1]];
	our $sec = ("00".."59")[(localtime)[0]];
	our $date = "$year$month$day-$hour$min$sec";
	return($date);
}
sub trim($) {
	my $string = shift;
	$string =~ s/\s+/ /g;	# remove all double whitespace
	$string =~ s/^\s+//g; # remove beginning whitespaces
	$string =~ s/\s+$//g;	# remove trailing whitespaces
	$string =~ s/\r//g; 	# remove newlines
	$string =~ s/\n//g; 	# remove newlines
	$string =~ s/^"//g; 	# remove beginning double quotes
	$string =~ s/"$//g; 	# remove trailing double quotes
	return $string;
}
sub plog {
        $text = shift;
        print("$text");
}
sub trimout {
        @trimin = ();
        @trimin = @out;
        @out = ();
        TRIM: foreach (@trimin) {
                if ( grep(/^$/i,$_) ) { next TRIM; }
                $_ =~ s/^\s+//g;    # remove beginning whitespaces
                $_ =~ s/\s+$//g;	# remove trailing whitespaces
                push(@out, $_);
        }
}
sub check_itmuser_run_securemain() {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # check if itmuser exists
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $userid = "itmuser";
        $itmuser_found = 0 ;

        $text = "check if ${userid} exists";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "id -g ${userid} | xargs getent group | cut -d: -f1 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        # if ( $debug ) { plog("\nout=>\n@out\n"); }
        trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);
        if ( $baz =~ /no such user/i ) {
                $itmuser_found = 0 ;
                plog("OK: ${userid} NOT found: $baz");
        } else {
                $itmuser_found = 1;
                $group = $baz;
                plog("OK: ${userid} found in group: $group");
        }
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # doublecheck to see if ITM is started under itmuser user
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        if ( $itmuser_found ) {
                ++$step;
                undef( @out );
                @out = ();$baz = '';
                $text = "check if ${userid} is used to start agents";
                plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

                $userid = "itmuser";
                # $cmdexec = "ps -ef | grep -i klzagent | grep -v grep | awk '{print $1}' 2>&1";
                $cmdexec = "ps -ef | grep -i klzagent | grep -v grep 2>&1";
                if ( $debug ) { plog("\n$cmdexec\n"); }
                @out = `$cmdexec`;
                if ( $debug ) { plog("\nout=>\n@out\n"); }
                trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);
                if ( $debug ) { plog("\nresult=>${baz}<=\n"); }
                ($foo,$bar) = split(/ /, $baz, -1);

                if ( $baz =~ /^${userid}/i ) {
                        $itmuser_found = 1;
                        $group = $baz;
                        plog("OK: ITM is stated using ${userid}, so we must run securemain");
                } else {
                        $itmuser_found = 0 ;
                        plog("OK: ITM is stated as root, no need for securemain");
                }
        }
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # secureMain for itmuser
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        if ( $itmuser_found ) {

                ++$step;
                undef( @out );
                @out = ();$baz = '';
                $text = "secureMain for ${userid}";
                plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

                $cmdexec = "/opt/IBM/ITM/bin/secureMain -g ${group} lock 2>&1";
                if ( $debug ) { plog("\n$cmdexec\n"); }
                @out = `$cmdexec`;
                if ( $debug ) { plog("\nout=>\n@out\n"); }
                trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);
                plog("OK: secureMain runned for ${userid}: $baz");
        }
}
sub start_agents {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run start lz agents
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "start lz agents";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        if ( $itmuser_found ) {
                $cmdexec = "sudo -u ${userid} /opt/IBM/ITM/bin/itmcmd agent start lz 2>&1";
        } else {
                $cmdexec = "/opt/IBM/ITM/bin/itmcmd agent start lz 2>&1";
        }

        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }
        trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);

        plog("OK: lz agent started: $baz");

        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run start 08 agents
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "start 08 agents";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        if ( $itmuser_found ) {
                $cmdexec = "sudo -u ${userid} /opt/IBM/ITM/bin/itmcmd agent start 08 2>&1";
        } else {
                $cmdexec = "/opt/IBM/ITM/bin/itmcmd agent start 08 2>&1";
        }

        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }
        trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);

        plog("OK: gsma agent started: $baz");

        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run start all agents if any is missed
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "start all agents";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        if ( $itmuser_found ) {
                $cmdexec = "sudo -u ${userid} /opt/IBM/ITM/bin/itmcmd agent start all 2>&1";
        } else {
                $cmdexec = "/opt/IBM/ITM/bin/itmcmd agent start all 2>&1";
        }

        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }
        trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);

        plog("OK: gsma agent started: $baz");
}
sub stop_all_agents {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run Stop all
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "stop 08 agent";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "/opt/IBM/ITM/bin/itmcmd agent -f stop all 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }

        plog("OK: agent 08 stopped");

        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run kill klzagent
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "kill klzagent";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "pkill -9 klzagent 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }
        plog("OK: klzagent stopped");

        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run kill k08agent
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "kill k08agent";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "pkill -9 k08agent 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }

        plog("OK: k08agent stopped");

}
sub list_processes {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # list all ITM processes
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "list all ITM processes";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "ps -ef | grep -i ITM 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }

        plog("OK: process listed");
}
sub uninstall_agents {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # run start lz agents
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "uninstall all agents";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        if ( $itmuser_found ) {
                $cmdexec = "sudo -u ${userid} /opt/IBM/ITM/bin/itmcmd agent start all 2>&1";
        } else {
                $cmdexec = " ksh /opt/IBM/ITM/bin/uninstall.sh REMOVE EVERYTHING";
        }

        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `sh $cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }
        trimout();$baz='';$baz = join(";", @out);$baz = trim($baz);

        plog("OK: ITM agent uninstalled: $baz");
}
sub cinfo {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # cinfo
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "cinfo  $agent agent";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "/opt/IBM/ITM/bin/cinfo -c $agent 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }

        plog("OK: cinfo completed");
}
sub listLogs {
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        # list dir
        # ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ++$step;
        undef( @out );
        @out = ();$baz = '';
        $text = "list Logs";
        plog(sprintf "\n%-13s - step:%02d - %-55s",get_date(),$step,$text);

        $cmdexec = "ls -lrt /opt/IBM/ITM/ 2>&1";
        if ( $debug ) { plog("\n$cmdexec\n"); }
        @out = `$cmdexec`;
        if ( $debug ) { plog("\nout=>\n@out\n"); }
}
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# begin - main
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
check_itmuser_run_securemain();

$agent = 'lz';
cinfo();
$agent = '08';
cinfo();

stop_all_agents();
list_processes();
uninstall_agents();
list_processes();
listLogs();