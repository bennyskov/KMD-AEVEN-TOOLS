---
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------
#step: begin and setup tunnel and credentials
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------
- name: '1.A - Create OS groups'
  hosts: localhost
  become: false
  gather_facts: false
  connection: local
  tasks:
    - name: '1.A.00 - Create OS machine_{{ ostype }}'
      group_by:
        key: 'machine_{{ ostype }}'
      changed_when: false
      when: ostype is defined
      delegate_to: localhost

- name: '2.B - Socks tunnel setup'
  hosts: localhost
  gather_facts: false
  tasks:
    - include_role: # Not numbered per rules
        name: ansible-role-event-socks-tunnel
        apply:
          check_mode: false
          run_once: true
          delegate_to: localhost
      vars:
        acc_id: '{{ blueid_shortcode }}'
        transaction_id: '{{ tower_job_id }}'
        trans_num: '{{ tower_job_id }}'

    - name: '2.B.00 - Set become user'
    - set_fact:
        ansible_become_method: runas
        ansible_become_user: system
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------
#step working on localhost
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------
- name: '3.C - gather_facts localhost'
  hosts: localhost
  gather_facts: true
  vars:
    tower_host: 'https://ansible-tower-web-svc-tower.apps.kmdcacf001.adminkmd.local'
    tower_username: 'functional_id_001'
    tower_password: 'm9AHKuXYa*MeZZWLsHqB'
  tasks:
    # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
    #step Export host from inventory
    # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
    - name: '3.C.00 - Export host from inventory'
      block:
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        #step debug facts and list local directories for ansible localhost
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        - name: '3.C.01 - Debug facts'
          debug:
            msg: |-
              '{{ ansible_facts }}'
          tags:
            - debug_facts

        - name: '3.C.02 - List homedir files'
          shell: 'ls -lrt'
          register: script_homedir

        - name: '3.C.03 - Output list homedir'
          debug:
            var: script_homedir.stdout_lines

        - name: '3.C.04 - List /tmp/'
          shell: 'ls -lrt /tmp/'
          register: script_tmp

        - name: '3.C.05 - Output list tmp'
          debug:
            var: script_tmp.stdout_lines
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        #step list host from inventory
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        - name: '3.C.06 - Create tower-cli config'
          include_role:
            name: towercli-init

        - name: '3.C.07 - Get host information using AWX command'
          shell: 'awx-cli host list --name={{ nodename }} -f yaml'
          register: host_response
          delegate_to: localhost
          failed_when: false
          changed_when: false

        - name: '3.C.08 - Set host data from command output'
          set_fact:
            host_data: '{{ host_response.stdout | from_yaml }}'
          when: host_response.rc == 0

        - name: '3.C.09 - List inventories for the host'
          debug:
            msg: 'Host {{ nodename }} found in inventory: {{ item.inventory_name }}'
          loop: '{{ host_data.results }}'
          when: host_data is defined and host_data.results | length > 0
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------
#
#step we are now running from remote host
#
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------
- name: '4.D - Export of on host from ansible itower inventory and then remove the host from all inventories'
  hosts: '{{ nodename }}'
  gather_facts: false
  become: false
  run_once: true
  ignore_errors: yes
  vars:
    nodename: '{{ nodename }}'
    ansib_user1: 'kmduxat1'
    ansib_user2: 'kmduxat2'
  tasks:
    # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
    #step Export host from inventory
    # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
    - name: '4.D.00 - cleanup ansible files on host {{ nodename }}'
      block:
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        #
        #step cleanup ansible
        #
        # '/var/opt/ansible/GTS',
        # '/var/opt/ansible/tmp',
        # '/var/opt/ansible/GTS/dataLake'
        #
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        - name: '4.D.01 - Delete ansible directory'
          file:
            path: /var/opt/ansible
            state: absent

        # - name: '4.D.02 - List /var/opt/ansible'
        #   shell: 'ls -lrta /var/opt/ansible'
        #   register: list_agentdir_out

        # - name: '4.D.03 - send output to ansible'
        #   debug:
        #     var: list_agentdir_out.stdout_lines
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        #step remove ansible users ansib_user1
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        - name: '4.D.04 - Check if {{ ansib_user1 }} already exists'
          command: 'id {{ ansib_user1 }}'
          register: unix_user_info

        # - name: '4.D.05 - Delete user {{ ansib_user1 }}'
        #   ignore_errors: true
        #   user:
        #     name: '{{ ansib_user1 }}'
        #     remove: '{{ data.remove_user_dirs | default(true) }}'
        #     state: absent

        # - name: '4.D.06 - Delete sudoers profile for {{ ansib_user1 }}'
        #   file:
        #     path: '/etc/sudoers.d/{{ ansib_user1 }}_sudo'
        #     state: absent
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        #step remove ansible users ansib_user2
        # -----------------------------------------------------------------------------------------------------------------------------------------------------------------
        - name: '4.D.07 - Check if {{ ansib_user2 }} already exists'
          command: 'id {{ ansib_user2 }}'
          register: unix_user_info_2

        # - name: '4.D.08 - Delete user {{ ansib_user2 }}'
        #   user:
        #     name: '{{ ansib_user2 }}'
        #     remove: '{{ data.remove_user_dirs | default(true) }}'
        #     state: absent

        # - name: '4.D.09 - Delete sudoers profile for {{ ansib_user2 }}'
        #   file:
        #     path: '/etc/sudoers.d/{{ ansib_user2 }}_sudo'
        #     state: absent